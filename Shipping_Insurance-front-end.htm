<mvt:comment> not functional yet. </mvt:comment>

<script>

  const divToggle = document.getElementById('divToggle');

  divToggle.addEventListener('click', function () {

    if (divToggle.classList.contains('loading')) return;

    divToggle.classList.add('loading');

    let shippingCost = divToggle.dataset.shipping_cost;
    let currentCharge = divToggle.dataset.current_charge;
    let rqstMode = divToggle.dataset.rqst_mode;

    // The div that holds the Line Item in the Basket summary
    let shipInsLineItem = document.getElementById('mainShipInsLineItemDiv');

    // The value shown in the Line item in the Basket summary
    let shipInsLineItemVal = document.getElementById('mainShipInsLineItemVal');

    // The div that holds the Line Item in the Mini Basket summary
    let miniShipInsLineItem = document.getElementById('miniShipInsLineItem');

    // The value shown in the Line item in the Mini Basket summary
    let miniShipInsLineItemVal = document.getElementById('miniShipInsLineItemVal');

    // Current Basket Total Elements
    let currentBasketTotal = document.getElementById('currentBasketTotal');
    let miniCurrentBasketTotal = document.getElementById('miniCurrentBasketTotal');

    // Current Basket Total Values (Probably only need one)
    let currentBasketTotalVal = Subtotal_div.dataset.current_subtotal;

    // API url
    const url = "/shipping-insurance-api.html?shipping_cost=" + shippingCost + "&current_charge=" + currentCharge + "request_mode=" + requestMode + "&ajax=1";

    fetch(url, {
      method: 'GET',
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.json())
    .then(data => {
      console.log('Response:', data);
        /*
        Responses
        
        SUCCESS RESPONSES
        S1: Charge Added Successfully
        S2: Charge Deleted Successfully
        S3: Charge Updated Successfully
        
        ERROR RESPONSES
        E0: ERROR - Charge Must Be Greater Than 0
        E1: ERROR - Subtotal too large. Contact Sales for insurance options.
        E2: ERROR - Current charge is less than 0. Charge Deleted.
        E3: ERROR - Invalid Request Mode
        E4: ERROR - Missing One Or More Request Parameters    

        */


    // Check if the api responded with an error message
    if(data.status_code.includes("E")){
      console.log(data.status_code)
      console.log(data.message)
      // Display Error Message on the screen also. Use a foreach because errors are returned in an array



    } else{

      if (rqstMode === 'add' || rqstMode === 'update'){
        // Handle Add / Update Mode

        // toggle to opposite value
        divToggle.dataset.rqst_mode = 'delete';

        // add Shipping Cost to line items (main and mini)

        // Make Line items visible
        shipInsLineItem.classList.remove('u-hidden-important');
        miniShipInsLineItem.classList.remove('u-hidden-important');

        // Update Basket Total

      } else{
        // Handle Delete Mode

        // toggle to opposite value
        divToggle.dataset.rqst_mode = 'add';

        // remove shipping cost from line items (main and mini)

        // Make Line Items Invisible

        // Update Basket Total

      }

      // Toggle the visual state
      divToggle.classList.toggle('active');

      }

    })
    .catch(error => {
      console.error('Error:', error);
    })
    .finally(() => {
      divToggle.classList.remove('loading');
    });
  });
</script>